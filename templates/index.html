<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Aura ChatBot de RRHH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    /* ... Tus estilos CSS aqu√≠, omite cualquier estilo Jinja antiguo ... */
    </style>
    <style>
        /* ... spinner thinking-indicator ... */
        .thinking-indicator {
            position: fixed;
            bottom: 70px;
            left: 0;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 110;
            font-size: 1.08rem;
            color: #128c7e;
            font-weight: 500;
            background: rgba(255,255,255,0.95);
            pointer-events: none;
            min-height: 32px;
        }
        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #c5e8d6;
            border-top: 3px solid #25d366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="top-bar-flex">
    <div class="chat-title-bar-centered">
        <span class="chat-title-icon">ü§ñ</span>
        <span class="chat-title">Aura ChatBot de RRHH</span>
    </div>
</div>
<div class="main-flex">
    <div class="chat-outerbox">
        <aside class="pdf-sidebar-vertical">
            <a class="pdf-link-minimal" href="/static/Prueba4.pdf" download title="Manual del Empleado">üìÑ Manual del Empleado</a>
            <a class="pdf-link-minimal" href="/static/C√≥digo%20del%20Trabajo-Chile.pdf" download title="C√≥digo del Trabajo">üìÑ C√≥digo del Trabajo</a>
        </aside>
        <div class="chat-main-area">
            <button id="scroll-bottom-btn" aria-label="Bajar al final" style="display:none;position:fixed;bottom:110px;right:30px;z-index:105;background:#25d366;color:#fff;border:none;border-radius:50%;width:42px;height:42px;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-size:1.6em;cursor:pointer;">‚Üì</button>
            <div class="chat-container" id="chat-container" tabindex="0" role="log" aria-live="polite" aria-label="Historial de chat">
                <!-- Renderizado solo por JS -->
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <button id="new-conv-btn" type="button" style="background:#128c7e;color:#fff;border:none;border-radius:8px;padding:7px 16px;font-size:1em;cursor:pointer;">Nueva conversaci√≥n</button>
                <button id="download-chat-btn" type="button" style="background:#b2dfdb;color:#222;border:none;border-radius:8px;padding:7px 16px;font-size:1em;cursor:pointer;">Descargar historial</button>
            </div>
            <form class="wa-input-bar" id="chat-form" method="post" action="/send_message">
                <div class="wa-input-inner">
                    <input type="text" class="wa-input-box" name="message" id="message" placeholder="Escribe tu mensaje..." autocomplete="off" required>
                    <button type="submit" class="wa-send-btn">Enviar</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="thinking-indicator" class="thinking-indicator" style="display:none;">
    <span class="spinner"></span> Aura est√° pensando...
</div>

<script>
// Usar Jinja default([]) para asegurar que existe y sea v√°lido JSON JS.
window.initialChatFromServer = {{ chat|default([])|tojson|safe }};
</script>

<script>
    // Borra historial local al cargar para forzar efecto m√°quina de escribir en recargas
    localStorage.removeItem('chatSession');

    function typeWriterEffect(element, text, speed = 21, callback = null) {
        if (!element || !text) return;
        element.innerHTML = "";
        let i = 0;
        function typing() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(typing, speed);
            } else if (callback) {
                callback();
            }
        }
        typing();
    }

    function renderChat(chat) {
        const chatContainer = document.getElementById('chat-container');
        let chatHtml = '';
        let lastBotIndex = -1;
        
        chat.forEach(function(msg, idx) {
            if (msg.role === 'user') {
                chatHtml += `<div class='msg-meta'>T√∫ | ${msg.timestamp || ""}</div><div class='msg-user msg-bubble-user'>${msg.content}</div>`;
            } else if (msg.role === 'assistant') {
                lastBotIndex = idx;
                chatHtml += `<div class='msg-meta'>Aura | ${msg.timestamp || ""}</div>`;
                
                // Efecto m√°quina de escribir SOLO para el √∫ltimo mensaje de bot
                if (idx === chat.length - 1) {
                    chatHtml += `<div class='msg-bot msg-bubble-bot'>
                        <span class="typewriter-effect"></span>
                        <div class='feedback-row'><span class='feedback-label'>¬øTe fue √∫til?</span>
                            <button class='feedback-btn' data-feedback='up' title='√ötil'>üëç</button>
                            <button class='feedback-btn' data-feedback='down' title='No √∫til'>üëé</button>
                        </div>
                    </div>`;
                } else {
                    chatHtml += `<div class='msg-bot msg-bubble-bot'>${msg.content}
                        <div class='feedback-row'><span class='feedback-label'>¬øTe fue √∫til?</span>
                            <button class='feedback-btn' data-feedback='up' title='√ötil'>üëç</button>
                            <button class='feedback-btn' data-feedback='down' title='No √∫til'>üëé</button>
                        </div>
                    </div>`;
                }
            }
        });
        
        chatContainer.innerHTML = chatHtml;

        // Aplica el efecto al √∫ltimo mensaje del bot
        if (lastBotIndex >= 0 && lastBotIndex === chat.length - 1) {
            setTimeout(function() {
                const lastBot = chat[lastBotIndex];
                const el = document.querySelector('.typewriter-effect');
                if (el && lastBot && lastBot.content) {
                    el.innerHTML = '';
                    typeWriterEffect(el, lastBot.content, 21, function() {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        saveChatToLocal();
                    });
                } else {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    saveChatToLocal();
                }
            }, 10);
        } else {
            setTimeout(function () {
                chatContainer.scrollTop = chatContainer.scrollHeight;
                saveChatToLocal();
            }, 60);
        }
        
        // Activar botones de feedback
        activateFeedbackButtons();
    }

    function saveChatToLocal() {
        if (!window._lastChat) return;
        localStorage.setItem('chatSession', JSON.stringify(window._lastChat));
    }

    // Feedback
    function activateFeedbackButtons() {
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.onclick = function () {
                btn.classList.add('selected');
                btn.blur();
                setTimeout(() => btn.classList.remove('selected'), 1000);
                // Aqu√≠ puedes enviar el feedback al backend si lo deseas
            };
        });
    }

    // Agrupar TODO el acceso y registro de eventos DOM dentro de onload para evitar errores por elementos no definidos
    window.onload = function () {
        if (window.initialChatFromServer) {
            window._lastChat = window.initialChatFromServer;
            renderChat(window._lastChat || []);
        }
        document.getElementById('chat-container').focus();

        // Bot√≥n bajar al final
        const scrollBtn = document.getElementById('scroll-bottom-btn');
        const chatContainer = document.getElementById('chat-container');
        chatContainer.addEventListener('scroll', function () {
            if (chatContainer.scrollTop < chatContainer.scrollHeight - chatContainer.clientHeight - 80) {
                scrollBtn.style.display = 'block';
                scrollBtn.style.opacity = 1;
            } else {
                scrollBtn.style.opacity = 0;
                setTimeout(() => { scrollBtn.style.display = 'none'; }, 250);
            }
        });
        scrollBtn.onclick = function() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        scrollBtn.onkeydown = function(e) { if(e.key==='Enter'||e.key===' '){chatContainer.scrollTop = chatContainer.scrollHeight;} };

        // Nueva conversaci√≥n
        document.getElementById('new-conv-btn').onclick = function () {
            if (confirm('¬øSeguro que deseas iniciar una nueva conversaci√≥n? Se perder√° el historial actual.')) {
                fetch('/reset_chat', { method: 'POST' }).then(() => {
                    localStorage.removeItem('chatSession');
                    location.reload();
                });
            }
        };

        // Descargar historial
        document.getElementById('download-chat-btn').onclick = function () {
            let text = '';
            document.querySelectorAll('.msg-meta, .msg-user, .msg-bot').forEach(el => {
                text += el.textContent + '\n';
            });
            let blob = new Blob([text], { type: 'text/plain' });
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'historial_chat.txt';
            link.click();
        };

        // Spinner escribiendo animado
        document.querySelector('.thinking-indicator .spinner').classList.add('dots');
    };

    // AJAX para enviar mensaje y mostrar historial
    document.getElementById('chat-form').onsubmit = async function (e) {
        e.preventDefault();
        var messageInput = document.getElementById('message');
        var msg = messageInput.value.trim();
        if (!msg) return;
        
        // A√±adir mensaje del usuario inmediatamente al chat
        const userMsg = {
            role: 'user',
            content: msg,
            timestamp: new Date().toLocaleTimeString().slice(0, 5)
        };
        
        // Si ya hay un chat, a√±adimos el mensaje
        if (window._lastChat && Array.isArray(window._lastChat)) {
            window._lastChat.push(userMsg);
            renderChat(window._lastChat);
        } else {
            window._lastChat = [userMsg];
            renderChat(window._lastChat);
        }
        
        messageInput.value = '';
        document.getElementById('thinking-indicator').style.display = 'flex';
        
        fetch('/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'message=' + encodeURIComponent(msg)
        })
        .then(response => response.json())
        .then(chat => {
            if (!Array.isArray(chat) || chat.length === 0) return;
            window._lastChat = chat;
            renderChat(chat);
        })
        .finally(() => {
            document.getElementById('thinking-indicator').style.display = 'none';
        });
    };

</script>
</body>
</html>